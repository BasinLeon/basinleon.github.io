<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Basin::Nexus | GTM Architecture Live</title>
    <meta name="description" content="Interactive GTM architecture class demo: live scoring, architecture trace, polls, simulation, and decision logic." />
    <meta property="og:title" content="Basin::Nexus | GTM Architecture Live" />
    <meta property="og:description" content="Run the GTM architecture model live with scoring, what-if compare, polling, simulation, and action tiers." />
    <style>
      :root {
        --ink: #f4f7fb;
        --muted: #b6c2d1;
        --line: rgba(255, 255, 255, 0.16);
        --panel: rgba(6, 16, 33, 0.62);
        --bg-1: #071225;
        --bg-2: #102848;
        --aqua: #00d1c8;
        --amber: #ffbf47;
        --crimson: #ff5d73;
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        min-height: 100vh;
        color: var(--ink);
        font-family: "Avenir Next", "Trebuchet MS", sans-serif;
        background:
          radial-gradient(circle at 15% 5%, rgba(0, 209, 200, 0.25), transparent 32%),
          radial-gradient(circle at 85% 10%, rgba(255, 93, 115, 0.2), transparent 28%),
          linear-gradient(145deg, var(--bg-1), var(--bg-2));
        padding: 20px;
      }
      .shell { max-width: 1320px; margin: 0 auto; }
      .hero {
        border: 1px solid var(--line);
        border-radius: 16px;
        background: linear-gradient(120deg, rgba(255,255,255,0.08), rgba(255,255,255,0.02));
        padding: 16px 18px;
        backdrop-filter: blur(8px);
      }
      .brand { margin: 0; font-size: clamp(1.4rem, 2.1vw, 2.3rem); }
      .sub { margin-top: 8px; color: var(--muted); }
      .proofRow { margin-top: 14px; display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 10px; }
      .proof {
        border: 1px solid var(--line);
        border-radius: 12px;
        padding: 11px 12px;
        background: rgba(255,255,255,0.04);
        display: grid;
        gap: 4px;
      }
      .proof strong,
      .proofMetric {
        display: block;
        font-size: 1.05rem;
        line-height: 1.2;
        font-weight: 800;
        letter-spacing: 0.01em;
        white-space: normal;
      }
      .proof span,
      .proofContext {
        display: block;
        color: var(--muted);
        line-height: 1.3;
        white-space: normal;
      }
      .heroControls { margin-top: 12px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
      .modeBtn { border: 1px solid var(--line); border-radius: 999px; background: rgba(255,255,255,0.08); color: var(--ink); padding: 8px 14px; font-weight: 700; cursor: pointer; }
      .stateTag { border-radius: 999px; border: 1px solid var(--line); padding: 6px 10px; font-size: 0.9rem; }

      .app { margin-top: 16px; display: grid; grid-template-columns: 1.15fr 1fr; gap: 16px; }
      .card { background: var(--panel); border: 1px solid var(--line); border-radius: 14px; padding: 16px; backdrop-filter: blur(8px); }
      h2 { margin: 0 0 8px; font-size: 1.2rem; }
      p { margin: 0; color: var(--muted); }

      .grid { display: grid; gap: 12px; margin-top: 14px; }
      .row { display: grid; grid-template-columns: 120px 1fr 40px; gap: 10px; align-items: center; }
      .row label { font-weight: 700; }
      .max { display: block; font-size: 0.8rem; color: var(--muted); }
      input[type="range"] { width: 100%; accent-color: #60e2ff; }
      input[type="number"], input[type="text"], textarea {
        width: 100%;
        border: 1px solid var(--line);
        border-radius: 8px;
        background: rgba(255,255,255,0.06);
        color: var(--ink);
        padding: 8px;
      }

      .score { margin-top: 14px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
      .box { border: 1px solid var(--line); border-radius: 10px; padding: 10px; }
      .n { font-size: 2rem; line-height: 1.1; font-weight: 800; }
      .pill { margin-top: 12px; display: inline-block; border-radius: 999px; border: 1px solid var(--line); padding: 8px 12px; font-weight: 700; }
      .tier-act { background: rgba(0, 209, 200, 0.24); }
      .tier-nurture { background: rgba(255, 191, 71, 0.26); }
      .tier-ignore { background: rgba(255, 93, 115, 0.24); }

      .miniGrid { margin-top: 12px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
      .barWrap { margin-top: 10px; display: grid; gap: 8px; }
      .barRow { display: grid; grid-template-columns: 80px 1fr 42px; gap: 8px; align-items: center; }
      .track { height: 8px; border-radius: 999px; background: rgba(255,255,255,0.12); overflow: hidden; }
      .fill { height: 100%; background: linear-gradient(90deg, #6ae0ff, #00d1c8); }

      .scenario { margin-top: 12px; display: grid; gap: 8px; }
      .scenario button, .actionBtn {
        border: 1px solid var(--line);
        border-radius: 10px;
        background: rgba(255,255,255,0.05);
        color: var(--ink);
        text-align: left;
        padding: 10px;
        cursor: pointer;
      }
      .actionRow { margin-top: 10px; display: flex; gap: 8px; flex-wrap: wrap; }
      .actionBtn { text-align: center; }

      .flow { margin-top: 14px; border-top: 1px solid var(--line); padding-top: 12px; }
      .nodes { display: grid; grid-template-columns: repeat(5, minmax(0, 1fr)); gap: 8px; }
      .node { border: 1px solid var(--line); border-radius: 10px; padding: 9px 8px; text-align: center; font-size: 0.88rem; background: rgba(255,255,255,0.04); }
      .arrow { text-align: center; margin: 6px 0; opacity: 0.75; }
      .prompt { margin-top: 12px; border-left: 3px solid var(--aqua); padding-left: 10px; }

      .switchView { margin-top: 12px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
      .stateCard { border: 1px solid var(--line); border-radius: 12px; padding: 12px; min-height: 110px; background: rgba(255,255,255,0.03); }
      .manual { border-color: rgba(255, 93, 115, 0.45); }
      .nexus { border-color: rgba(0, 209, 200, 0.45); }
      .focusRing { box-shadow: 0 0 0 2px rgba(0, 209, 200, 0.45), 0 0 20px rgba(0, 209, 200, 0.2); }

      .history { margin-top: 12px; max-height: 185px; overflow: auto; border: 1px solid var(--line); border-radius: 10px; padding: 8px; background: rgba(255,255,255,0.03); }
      .history ul { margin: 0; padding-left: 18px; }
      .history li { margin: 4px 0; color: var(--muted); font-size: 0.9rem; }

      .progress { margin-top: 10px; }
      .progress .track { height: 10px; }
      .progress .fill { background: linear-gradient(90deg, #ffbf47, #00d1c8); width: 0%; }

      .poll { margin-top: 12px; display: grid; gap: 8px; }
      .poll button { text-align: left; }
      .kpiGrid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 8px; }
      .kbdHint { margin-top: 8px; font-size: 0.85rem; color: var(--muted); }

      body.class-mode .sub, body.class-mode .proofRow, body.class-mode .miniGrid, body.class-mode .barWrap, body.class-mode .scenario, body.class-mode .poll, body.class-mode .studentInput, body.class-mode .comparePanel, body.class-mode .simPanel, body.class-mode .opsPanel, body.class-mode .surveyPanel, body.class-mode .cuePanel { display: none; }
      body.class-mode .app { grid-template-columns: 1fr; }

      @media (max-width: 980px) {
        .proofRow, .app, .miniGrid, .switchView, .score, .kpiGrid { grid-template-columns: 1fr; }
      }
    </style>
  </head>
  <body>
    <div class="shell">
      <header class="hero">
        <h1 class="brand">Basin::Nexus | GTM Architecture Live</h1>
        <p class="sub">Interactive class model: score logic, action decisions, architecture trace, and live experiments.</p>
        <div class="proofRow">
          <div class="proof">
            <div class="proofMetric">$424K saved + 160% growth</div>
            <div class="proofContext">Project Sentinel outcome</div>
          </div>
          <div class="proof">
            <div class="proofMetric">18x faster ramp</div>
            <div class="proofContext">Enablement systemization impact</div>
          </div>
          <div class="proof">
            <div class="proofMetric">3 SQLs in 48h @ $0 CAC</div>
            <div class="proofContext">Signal-to-action speed proof</div>
          </div>
        </div>
        <div class="heroControls">
          <button id="classModeBtn" class="modeBtn">Presenter Mode: OFF</button>
          <button id="archToggleBtn" class="modeBtn">Architecture: OFF (Manual)</button>
          <span id="archStateTag" class="stateTag">Current View: Manual GTM</span>
          <span id="jsStatus" class="stateTag">Interactive: loading...</span>
        </div>
      </header>

      <div class="app">
        <section class="card" id="leftCard">
          <h2>Live Scoring Console</h2>
          <p>Signal Score = Intent (0-30) + Fit (0-30) + Urgency (0-20) + Trust (0-20)</p>

          <div class="studentInput box" style="margin-top:12px;">
            <strong>Student Input Mode</strong>
            <div style="margin-top:8px; display:grid; gap:8px;">
              <input id="startupName" type="text" placeholder="Startup name (live from class)" />
              <textarea id="startupContext" rows="2" placeholder="Type context: ICP, bottleneck, constraint"></textarea>
              <div class="miniGrid">
                <label>Intent <input id="intentNum" type="number" min="0" max="30" value="18" /></label>
                <label>Fit <input id="fitNum" type="number" min="0" max="30" value="20" /></label>
                <label>Urgency <input id="urgencyNum" type="number" min="0" max="20" value="12" /></label>
                <label>Trust <input id="trustNum" type="number" min="0" max="20" value="14" /></label>
              </div>
            </div>
          </div>

          <div class="grid">
            <div class="row"><label for="intent">Intent <span class="max">max 30</span></label><input id="intent" type="range" min="0" max="30" value="18" /><strong id="intentVal">18</strong></div>
            <div class="row"><label for="fit">Fit <span class="max">max 30</span></label><input id="fit" type="range" min="0" max="30" value="20" /><strong id="fitVal">20</strong></div>
            <div class="row"><label for="urgency">Urgency <span class="max">max 20</span></label><input id="urgency" type="range" min="0" max="20" value="12" /><strong id="urgencyVal">12</strong></div>
            <div class="row"><label for="trust">Trust <span class="max">max 20</span></label><input id="trust" type="range" min="0" max="20" value="14" /><strong id="trustVal">14</strong></div>
          </div>

          <div class="score">
            <div class="box"><div>Score</div><div class="n" id="score">64</div></div>
            <div class="box"><div>Action Tier</div><div class="n" id="tier" style="font-size:1.3rem">Nurture This Week</div></div>
          </div>

          <span id="tierPill" class="pill tier-nurture">Nurture This Week</span>

          <div class="miniGrid">
            <div class="box"><strong>What This Means</strong><p id="tierExplain" style="margin-top:6px;line-height:1.4">Run a nurture sequence this week and collect one stronger intent signal.</p></div>
            <div class="box"><strong>Next Best Lever</strong><p id="leverHint" style="margin-top:6px;line-height:1.4">Increase Trust to move fastest.</p></div>
          </div>

          <div class="barWrap" id="bars"></div>

          <div class="scenario">
            <button data-preset="founder">Founder-led chaos: strong intent, weak trust</button>
            <button data-preset="mid">Mid-market lukewarm: medium signal and medium urgency</button>
            <button data-preset="cold">Cold account: low urgency, low trust</button>
          </div>

          <div class="comparePanel box" style="margin-top:12px;">
            <strong>What-if Compare (Before / After)</strong>
            <div class="actionRow">
              <button id="setBaselineBtn" class="actionBtn">Set Baseline</button>
              <button id="clearBaselineBtn" class="actionBtn">Clear Baseline</button>
            </div>
            <p id="compareOut" style="margin-top:8px;">No baseline yet. Click "Set Baseline".</p>
          </div>

          <div class="simPanel box" style="margin-top:12px;">
            <strong>Cold -> Warm -> Hot Autoplay (60s)</strong>
            <div class="actionRow">
              <button id="startSimBtn" class="actionBtn">Start 60s Simulation</button>
              <button id="stopSimBtn" class="actionBtn">Stop</button>
            </div>
            <p id="simState" style="margin-top:8px;">Simulation idle.</p>
            <div class="progress">
              <div class="track"><div id="simFill" class="fill"></div></div>
            </div>
          </div>

          <div class="opsPanel box" style="margin-top:12px;">
            <strong>KPI Projection + Confidence</strong>
            <div id="kpiBand" style="margin-top:8px;">Tier band: Nurture This Week</div>
            <div class="kpiGrid">
              <div class="box"><div>Meeting Rate</div><div id="kpiMeet" class="n" style="font-size:1.3rem;">14%</div></div>
              <div class="box"><div>SQL Probability</div><div id="kpiSql" class="n" style="font-size:1.3rem;">8%</div></div>
            </div>
            <div style="margin-top:8px;">Confidence: <strong id="confidencePct">68%</strong></div>
            <div id="confidenceFlags" style="margin-top:6px; color: var(--muted);"></div>
          </div>

          <div class="opsPanel box" style="margin-top:12px;">
            <strong>Objection Simulator</strong>
            <div class="actionRow">
              <button class="actionBtn" data-objection="low_trust">Low trust</button>
              <button class="actionBtn" data-objection="no_urgency">No urgency</button>
              <button class="actionBtn" data-objection="poor_fit">Poor fit</button>
            </div>
            <p id="objectionOut" style="margin-top:8px;">Pick an objection to see guided response.</p>
          </div>

          <div class="opsPanel box" style="margin-top:12px;">
            <strong>Save Class Run</strong>
            <div class="actionRow">
              <button id="saveJsonBtn" class="actionBtn">Export JSON</button>
              <button id="saveCsvBtn" class="actionBtn">Export CSV</button>
            </div>
            <div class="kbdHint">Hotkeys: <code>1/2/3</code> presets, <code>M</code> mode, <code>A</code> architecture, <code>S</code> baseline, <code>P</code> poll apply, <code>T</code> simulation.</div>
          </div>
        </section>

        <section class="card">
          <h2>Architecture Trace</h2>
          <p>As inputs move, show how the system decides the next GTM action.</p>

          <div class="flow">
            <div class="nodes">
              <div class="node">Intent Signals</div>
              <div class="node">Ingestion</div>
              <div class="node">Enrichment</div>
              <div class="node">Reasoning</div>
              <div class="node">Action Tier</div>
            </div>
            <div class="arrow">↓</div>
            <div class="node">Revenue Outcome</div>
          </div>

          <div class="prompt">Class prompt: “Which single variable changes outcome most, and why?”</div>

          <div class="switchView">
            <div id="manualCard" class="stateCard manual focusRing">
              <strong>OFF: Manual GTM</strong>
              <ul>
                <li>High activity, low precision</li>
                <li>Pipeline quality varies by rep effort</li>
                <li>Slow feedback loops and lead decay</li>
              </ul>
            </div>
            <div id="nexusCard" class="stateCard nexus">
              <strong>ON: Basin::Nexus</strong>
              <ul>
                <li>Signal-prioritized targeting</li>
                <li>Decision logic drives next action</li>
                <li>Consistent system learning over time</li>
              </ul>
            </div>
          </div>

          <div class="poll box">
            <strong>Quick Poll: Which lever should we move next?</strong>
            <button data-poll="intent">Vote Intent <span id="vote_intent">(0)</span></button>
            <button data-poll="fit">Vote Fit <span id="vote_fit">(0)</span></button>
            <button data-poll="urgency">Vote Urgency <span id="vote_urgency">(0)</span></button>
            <button data-poll="trust">Vote Trust <span id="vote_trust">(0)</span></button>
            <div class="actionRow">
              <button id="applyVoteBtn" class="actionBtn">Apply Top Vote (+5)</button>
              <button id="resetVoteBtn" class="actionBtn">Reset Votes</button>
            </div>
          </div>

          <div class="surveyPanel box">
            <strong>Live Market Trend Survey</strong>
            <button data-trend="signal_quality">Signal quality matters more than volume</button>
            <button data-trend="speed_to_action">Speed-to-action beats perfect messaging</button>
            <button data-trend="trust_over_sequence">Trust signals outperform long sequences</button>
            <button data-trend="ai_orchestration">AI orchestration is now GTM baseline</button>
            <div style="margin-top:8px; color: var(--muted);" id="trendOut">No trend votes yet.</div>
          </div>

          <div class="cuePanel box">
            <strong>Facilitation Cue Rail</strong>
            <div id="cueNow" style="margin-top:8px;">00:00-02:00 | Interactive opener</div>
            <div class="actionRow">
              <button id="cueStartBtn" class="actionBtn">Start Cue Timer</button>
              <button id="cueNextBtn" class="actionBtn">Next Cue</button>
              <button id="cueResetBtn" class="actionBtn">Reset</button>
            </div>
          </div>

          <div class="history">
            <strong>Decision Timeline</strong>
            <ul id="historyList"></ul>
          </div>
        </section>
      </div>
    </div>

    <script>
      // Inline model functions (no module import) for wider compatibility.
      const clamp = (value, min, max) => Math.max(min, Math.min(max, Number(value) || 0));
      const LIMITS = { intent: 30, fit: 30, urgency: 20, trust: 20 };
      const computeScore = ({ intent, fit, urgency, trust }) =>
        clamp(intent, 0, LIMITS.intent) +
        clamp(fit, 0, LIMITS.fit) +
        clamp(urgency, 0, LIMITS.urgency) +
        clamp(trust, 0, LIMITS.trust);
      const tierFromScore = (score) => {
        const s = clamp(score, 0, 100);
        if (s >= 75) return 'Act Now';
        if (s >= 50) return 'Nurture This Week';
        return 'Ignore / Archive';
      };
      const nextBestLever = ({ intent, fit, urgency, trust }) => {
        const current = {
          intent: clamp(intent, 0, LIMITS.intent),
          fit: clamp(fit, 0, LIMITS.fit),
          urgency: clamp(urgency, 0, LIMITS.urgency),
          trust: clamp(trust, 0, LIMITS.trust),
        };
        const headroom = Object.keys(current).map((key) => ({ key, delta: LIMITS[key] - current[key] }));
        headroom.sort((a, b) => b.delta - a.delta);
        return headroom[0];
      };
      const explainTier = (tier) => {
        if (tier === 'Act Now') return 'Launch direct outreach now with clear CTA and owner assignment.';
        if (tier === 'Nurture This Week') return 'Run a nurture sequence this week and collect one stronger intent signal.';
        return 'Park this account and redirect energy to higher-signal opportunities.';
      };
      const compareSnapshots = (before, after) => {
        const b = {
          intent: clamp(before.intent, 0, LIMITS.intent), fit: clamp(before.fit, 0, LIMITS.fit),
          urgency: clamp(before.urgency, 0, LIMITS.urgency), trust: clamp(before.trust, 0, LIMITS.trust),
        };
        const a = {
          intent: clamp(after.intent, 0, LIMITS.intent), fit: clamp(after.fit, 0, LIMITS.fit),
          urgency: clamp(after.urgency, 0, LIMITS.urgency), trust: clamp(after.trust, 0, LIMITS.trust),
        };
        const beforeScore = computeScore(b);
        const afterScore = computeScore(a);
        return {
          before: b, after: a, beforeScore, afterScore, delta: afterScore - beforeScore,
          beforeTier: tierFromScore(beforeScore), afterTier: tierFromScore(afterScore),
        };
      };
      const simulationSteps = () => ([
        { label: 'Cold', values: { intent: 7, fit: 9, urgency: 5, trust: 4 } },
        { label: 'Warm', values: { intent: 16, fit: 18, urgency: 10, trust: 11 } },
        { label: 'Hot', values: { intent: 27, fit: 24, urgency: 17, trust: 15 } },
      ]);
      const projectKpis = (score) => {
        const s = clamp(score, 0, 100);
        const tier = tierFromScore(s);
        let meetingRatePct = 4;
        let sqlProbabilityPct = 2;
        if (tier === 'Nurture This Week') {
          meetingRatePct = 10 + Math.round((s - 50) * 0.35);
          sqlProbabilityPct = 6 + Math.round((s - 50) * 0.2);
        }
        if (tier === 'Act Now') {
          meetingRatePct = 20 + Math.round((s - 75) * 0.4);
          sqlProbabilityPct = 12 + Math.round((s - 75) * 0.25);
        }
        return { tier, meetingRatePct, sqlProbabilityPct };
      };
      const confidenceMeter = ({ intent, fit, urgency, trust }) => {
        const d = {
          intent: clamp(intent, 0, LIMITS.intent),
          fit: clamp(fit, 0, LIMITS.fit),
          urgency: clamp(urgency, 0, LIMITS.urgency),
          trust: clamp(trust, 0, LIMITS.trust),
        };
        const flags = [];
        if (d.trust < 8) flags.push('Low trust: add proof / referral.');
        if (d.urgency < 8) flags.push('Low urgency: tie to trigger date.');
        if (d.intent < 10) flags.push('Weak intent signal source.');
        if (d.fit < 12) flags.push('Weak fit: tighten ICP.');
        const confidencePct = Math.max(10, Math.min(95, 100 - flags.length * 18));
        return { flags, confidencePct };
      };
      const objectionResponse = (key) => {
        const map = {
          low_trust: 'Lead with one quantified proof + low-friction pilot CTA.',
          no_urgency: 'Anchor to a dated trigger and cost-of-delay framing.',
          poor_fit: 'Disqualify fast or reposition to tighter ICP segment.',
        };
        return map[key] || 'Clarify blocker and define one measurable next step.';
      };

      const inputs = {
        intent: document.querySelector('#intent'),
        fit: document.querySelector('#fit'),
        urgency: document.querySelector('#urgency'),
        trust: document.querySelector('#trust'),
      };
      const numInputs = {
        intent: document.querySelector('#intentNum'),
        fit: document.querySelector('#fitNum'),
        urgency: document.querySelector('#urgencyNum'),
        trust: document.querySelector('#trustNum'),
      };
      const values = {
        intent: document.querySelector('#intentVal'),
        fit: document.querySelector('#fitVal'),
        urgency: document.querySelector('#urgencyVal'),
        trust: document.querySelector('#trustVal'),
      };

      const scoreEl = document.querySelector('#score');
      const tierEl = document.querySelector('#tier');
      const tierPill = document.querySelector('#tierPill');
      const tierExplainEl = document.querySelector('#tierExplain');
      const leverHintEl = document.querySelector('#leverHint');
      const barsEl = document.querySelector('#bars');
      const historyList = document.querySelector('#historyList');
      const classModeBtn = document.querySelector('#classModeBtn');
      const archToggleBtn = document.querySelector('#archToggleBtn');
      const archStateTag = document.querySelector('#archStateTag');
      const manualCard = document.querySelector('#manualCard');
      const nexusCard = document.querySelector('#nexusCard');
      const compareOut = document.querySelector('#compareOut');
      const setBaselineBtn = document.querySelector('#setBaselineBtn');
      const clearBaselineBtn = document.querySelector('#clearBaselineBtn');
      const startSimBtn = document.querySelector('#startSimBtn');
      const stopSimBtn = document.querySelector('#stopSimBtn');
      const simState = document.querySelector('#simState');
      const simFill = document.querySelector('#simFill');
      const applyVoteBtn = document.querySelector('#applyVoteBtn');
      const resetVoteBtn = document.querySelector('#resetVoteBtn');
      const jsStatus = document.querySelector('#jsStatus');
      const kpiBand = document.querySelector('#kpiBand');
      const kpiMeet = document.querySelector('#kpiMeet');
      const kpiSql = document.querySelector('#kpiSql');
      const confidencePctEl = document.querySelector('#confidencePct');
      const confidenceFlags = document.querySelector('#confidenceFlags');
      const objectionOut = document.querySelector('#objectionOut');
      const saveJsonBtn = document.querySelector('#saveJsonBtn');
      const saveCsvBtn = document.querySelector('#saveCsvBtn');
      const cueNow = document.querySelector('#cueNow');
      const cueStartBtn = document.querySelector('#cueStartBtn');
      const cueNextBtn = document.querySelector('#cueNextBtn');
      const cueResetBtn = document.querySelector('#cueResetBtn');
      const trendOut = document.querySelector('#trendOut');

      const humanName = (k) => k.charAt(0).toUpperCase() + k.slice(1);
      const getCurrent = () => ({ intent: Number(inputs.intent.value), fit: Number(inputs.fit.value), urgency: Number(inputs.urgency.value), trust: Number(inputs.trust.value) });

      let lastTier = '';
      let classMode = false;
      let architectureOn = false;
      let baseline = null;
      let simInterval = null;
      let simTick = 0;
      let votes = { intent: 0, fit: 0, urgency: 0, trust: 0 };
      let cueIndex = 0;
      let cueTimer = null;
      let cueElapsed = 0;
      const classRun = [];
      const trendVotes = { signal_quality: 0, speed_to_action: 0, trust_over_sequence: 0, ai_orchestration: 0 };
      const cueRail = [
        '00:00-02:00 | Interactive opener',
        '02:00-04:00 | Why GTM breaks',
        '04:00-06:00 | 4-layer model',
        '06:00-25:00 | Group experiment',
        '25:00-35:00 | Share-out + debrief',
        '35:00-45:00 | Q&A + close',
      ];

      const writeHistory = (line) => {
        const li = document.createElement('li');
        li.textContent = line;
        historyList.prepend(li);
        while (historyList.children.length > 10) historyList.removeChild(historyList.lastChild);
      };

      const applyTierClass = (tier) => {
        tierPill.classList.remove('tier-act', 'tier-nurture', 'tier-ignore');
        if (tier === 'Act Now') tierPill.classList.add('tier-act');
        else if (tier === 'Nurture This Week') tierPill.classList.add('tier-nurture');
        else tierPill.classList.add('tier-ignore');
      };

      const renderBars = (data) => {
        barsEl.innerHTML = '';
        Object.keys(data).forEach((key) => {
          const pct = Math.round((data[key] / LIMITS[key]) * 100);
          const row = document.createElement('div');
          row.className = 'barRow';
          row.innerHTML = `<span>${humanName(key)}</span><div class="track"><div class="fill" style="width:${pct}%"></div></div><strong>${pct}%</strong>`;
          barsEl.appendChild(row);
        });
      };

      const syncNumberFields = (data) => {
        Object.keys(numInputs).forEach((k) => { numInputs[k].value = String(data[k]); });
      };

      const renderCompare = (data) => {
        if (!baseline) {
          compareOut.textContent = 'No baseline yet. Click "Set Baseline".';
          return;
        }
        const cmp = compareSnapshots(baseline, data);
        compareOut.textContent = `Before ${cmp.beforeScore} (${cmp.beforeTier}) -> Now ${cmp.afterScore} (${cmp.afterTier}) | Delta ${cmp.delta >= 0 ? '+' : ''}${cmp.delta}`;
      };

      const renderVotes = () => {
        Object.keys(votes).forEach((k) => {
          document.querySelector(`#vote_${k}`).textContent = `(${votes[k]})`;
        });
      };

      const renderArchitectureToggle = () => {
        if (architectureOn) {
          archToggleBtn.textContent = 'Architecture: ON (Basin::Nexus)';
          archStateTag.textContent = 'Current View: Basin::Nexus';
          manualCard.classList.remove('focusRing');
          nexusCard.classList.add('focusRing');
        } else {
          archToggleBtn.textContent = 'Architecture: OFF (Manual)';
          archStateTag.textContent = 'Current View: Manual GTM';
          nexusCard.classList.remove('focusRing');
          manualCard.classList.add('focusRing');
        }
      };

      const render = () => {
        const data = getCurrent();
        Object.keys(values).forEach((k) => { values[k].textContent = String(data[k]); });
        syncNumberFields(data);
        const score = computeScore(data);
        const tier = tierFromScore(score);
        const best = nextBestLever(data);
        const kpi = projectKpis(score);
        const confidence = confidenceMeter(data);
        scoreEl.textContent = String(score);
        tierEl.textContent = tier;
        tierPill.textContent = tier;
        tierExplainEl.textContent = explainTier(tier);
        leverHintEl.textContent = `Increase ${humanName(best.key)} next (headroom: +${best.delta}).`;
        kpiBand.textContent = `Tier band: ${kpi.tier}`;
        kpiMeet.textContent = `${kpi.meetingRatePct}%`;
        kpiSql.textContent = `${kpi.sqlProbabilityPct}%`;
        confidencePctEl.textContent = `${confidence.confidencePct}%`;
        confidenceFlags.textContent = confidence.flags.length ? confidence.flags.join(' ') : 'No critical assumption flags.';
        applyTierClass(tier);
        renderBars(data);
        renderCompare(data);
        if (tier !== lastTier) {
          writeHistory(`Score ${score} -> ${tier}`);
          lastTier = tier;
        }
      };

      Object.values(inputs).forEach((input) => input.addEventListener('input', render));
      Object.keys(numInputs).forEach((k) => {
        numInputs[k].addEventListener('input', () => {
          const max = LIMITS[k];
          let v = Number(numInputs[k].value);
          if (!Number.isFinite(v)) v = 0;
          v = Math.max(0, Math.min(max, v));
          inputs[k].value = String(v);
          render();
        });
      });

      const presets = {
        founder: { intent: 27, fit: 24, urgency: 17, trust: 7 },
        mid: { intent: 16, fit: 18, urgency: 10, trust: 11 },
        cold: { intent: 7, fit: 9, urgency: 5, trust: 4 },
      };
      document.querySelectorAll('[data-preset]').forEach((btn) => {
        btn.addEventListener('click', () => {
          const p = presets[btn.dataset.preset];
          Object.keys(p).forEach((k) => { inputs[k].value = String(p[k]); });
          writeHistory(`Preset loaded: ${btn.textContent.trim()}`);
          classRun.push({ ts: Date.now(), type: 'preset', value: btn.dataset.preset, snapshot: getCurrent() });
          render();
        });
      });

      setBaselineBtn.addEventListener('click', () => { baseline = getCurrent(); writeHistory('Baseline set for what-if compare.'); render(); });
      clearBaselineBtn.addEventListener('click', () => { baseline = null; writeHistory('Baseline cleared.'); render(); });
      document.querySelectorAll('[data-objection]').forEach((btn) => {
        btn.addEventListener('click', () => {
          const key = btn.dataset.objection;
          objectionOut.textContent = objectionResponse(key);
          writeHistory(`Objection selected: ${key}`);
          classRun.push({ ts: Date.now(), type: 'objection', value: key });
        });
      });

      const stopSimulation = () => { if (simInterval) { clearInterval(simInterval); simInterval = null; } };
      startSimBtn.addEventListener('click', () => {
        stopSimulation();
        const steps = simulationSteps();
        simTick = 0;
        simFill.style.width = '0%';
        simState.textContent = 'Simulation started.';
        writeHistory('Simulation started: Cold -> Warm -> Hot (60s).');
        const runStep = (index) => {
          const step = steps[index];
          Object.keys(step.values).forEach((k) => { inputs[k].value = String(step.values[k]); });
          simState.textContent = `Phase: ${step.label}`;
          writeHistory(`Simulation phase: ${step.label}`);
          classRun.push({ ts: Date.now(), type: 'simulation', value: step.label, snapshot: getCurrent() });
          render();
        };
        runStep(0);
        simInterval = setInterval(() => {
          simTick += 1;
          const pct = Math.min(100, Math.round((simTick / 60) * 100));
          simFill.style.width = `${pct}%`;
          if (simTick === 20) runStep(1);
          if (simTick === 40) runStep(2);
          if (simTick >= 60) {
            stopSimulation();
            simState.textContent = 'Simulation complete.';
            writeHistory('Simulation complete.');
          }
        }, 1000);
      });
      stopSimBtn.addEventListener('click', () => { stopSimulation(); simState.textContent = 'Simulation stopped.'; writeHistory('Simulation stopped.'); });

      document.querySelectorAll('[data-poll]').forEach((btn) => {
        btn.addEventListener('click', () => {
          const key = btn.dataset.poll;
          votes[key] += 1;
          renderVotes();
          classRun.push({ ts: Date.now(), type: 'poll_vote', key, count: votes[key] });
        });
      });
      applyVoteBtn.addEventListener('click', () => {
        const sorted = Object.entries(votes).sort((a,b) => b[1]-a[1]);
        const [key, count] = sorted[0];
        if (!count) { writeHistory('No votes yet to apply.'); return; }
        const curr = Number(inputs[key].value);
        inputs[key].value = String(Math.min(LIMITS[key], curr + 5));
        writeHistory(`Applied top vote: ${humanName(key)} +5.`);
        classRun.push({ ts: Date.now(), type: 'poll_apply', key });
        render();
      });
      resetVoteBtn.addEventListener('click', () => { votes = { intent: 0, fit: 0, urgency: 0, trust: 0 }; renderVotes(); writeHistory('Votes reset.'); });

      classModeBtn.addEventListener('click', () => {
        classMode = !classMode;
        document.body.classList.toggle('class-mode', classMode);
        classModeBtn.textContent = `Presenter Mode: ${classMode ? 'ON' : 'OFF'}`;
        writeHistory(`Presenter mode ${classMode ? 'enabled' : 'disabled'}.`);
      });
      archToggleBtn.addEventListener('click', () => {
        architectureOn = !architectureOn;
        renderArchitectureToggle();
        writeHistory(`Architecture switched to ${architectureOn ? 'Basin::Nexus (ON)' : 'Manual GTM (OFF)'}.`);
      });

      document.querySelectorAll('[data-trend]').forEach((btn) => {
        btn.addEventListener('click', () => {
          const key = btn.dataset.trend;
          trendVotes[key] += 1;
          const top = Object.entries(trendVotes).sort((a,b)=>b[1]-a[1])[0];
          trendOut.textContent = `Top trend signal: ${top[0]} (${top[1]} votes)`;
          classRun.push({ ts: Date.now(), type: 'trend_vote', key, count: trendVotes[key] });
        });
      });

      const updateCue = () => {
        cueNow.textContent = cueRail[cueIndex] || cueRail[cueRail.length - 1];
      };
      cueStartBtn.addEventListener('click', () => {
        if (cueTimer) return;
        cueTimer = setInterval(() => {
          cueElapsed += 1;
          if (cueElapsed % 120 === 0 && cueIndex < cueRail.length - 1) {
            cueIndex += 1;
            updateCue();
          }
        }, 1000);
        writeHistory('Cue timer started.');
      });
      cueNextBtn.addEventListener('click', () => {
        cueIndex = Math.min(cueRail.length - 1, cueIndex + 1);
        updateCue();
        writeHistory('Moved to next cue.');
      });
      cueResetBtn.addEventListener('click', () => {
        if (cueTimer) { clearInterval(cueTimer); cueTimer = null; }
        cueElapsed = 0;
        cueIndex = 0;
        updateCue();
        writeHistory('Cue rail reset.');
      });

      const toCsv = (rows) => {
        const cols = ['ts','type','key','value','intent','fit','urgency','trust'];
        const lines = [cols.join(',')];
        rows.forEach((r) => {
          const s = r.snapshot || {};
          const vals = [
            r.ts || '', r.type || '', r.key || '', r.value || '',
            s.intent ?? '', s.fit ?? '', s.urgency ?? '', s.trust ?? ''
          ].map((v) => String(v).replaceAll(',', ';'));
          lines.push(vals.join(','));
        });
        return lines.join('\\n');
      };
      const download = (name, text, type) => {
        const blob = new Blob([text], { type });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = name;
        a.click();
        URL.revokeObjectURL(url);
      };
      saveJsonBtn.addEventListener('click', () => {
        const payload = { exportedAt: new Date().toISOString(), classRun, votes, trendVotes, current: getCurrent() };
        download('scu_class_run.json', JSON.stringify(payload, null, 2), 'application/json');
        writeHistory('Exported class run JSON.');
      });
      saveCsvBtn.addEventListener('click', () => {
        download('scu_class_run.csv', toCsv(classRun), 'text/csv');
        writeHistory('Exported class run CSV.');
      });

      window.addEventListener('keydown', (e) => {
        if (['INPUT','TEXTAREA'].includes(document.activeElement.tagName)) return;
        const k = e.key.toLowerCase();
        if (k === '1') document.querySelector('[data-preset=\"cold\"]').click();
        if (k === '2') document.querySelector('[data-preset=\"mid\"]').click();
        if (k === '3') document.querySelector('[data-preset=\"founder\"]').click();
        if (k === 'm') classModeBtn.click();
        if (k === 'a') archToggleBtn.click();
        if (k === 's') setBaselineBtn.click();
        if (k === 'p') applyVoteBtn.click();
        if (k === 't') startSimBtn.click();
      });

      // JS health signal
      if (jsStatus) {
        jsStatus.textContent = 'Interactive: ON';
      }

      renderVotes();
      renderArchitectureToggle();
      updateCue();
      writeHistory('Session started: move sliders to trace GTM decisions.');
      render();
    </script>
  </body>
</html>
